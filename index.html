<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>简化版 Promo Code 演示（按日期生成）</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#f6f8fb;color:#111;padding:24px;}
  .container{max-width:760px;margin:24px auto;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(13,38,76,.08);padding:24px;}
  h1{margin:0 0 8px;font-size:1.4rem}
  label{display:block;margin-top:12px;font-weight:600;font-size:.9rem}
  input[type=text],input[type=date],select{width:100%;padding:10px;border:1px solid #d7dbe6;border-radius:6px;margin-top:6px;box-sizing:border-box}
  button{background:#1466f1;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;margin-top:14px;cursor:pointer}
  .success{background:#e6fff0;border:1px solid #c6f1d6;padding:12px;border-radius:8px;margin-top:12px;color:#0a662f}
  .card{background:#fff4f4;border:1px solid #ffd4d4;border-radius:10px;padding:12px;margin-top:12px}
  .danger-text{color:#c62828;font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border:1px solid #eee;text-align:left;font-size:.9rem}
  .hidden{display:none}
  /* 弹窗 */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(520px,92vw);padding:18px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
  .btn-secondary{background:#e7ebf3;color:#223}
</style>
</head>
<body>
<div class="container">
  <h1>简化版 Promo Code 演示（按日期生成）</h1>
  <form id="promoForm" onsubmit="return false;">
    <label>出发地（From）
      <input required id="from" type="text" placeholder="例如：Melbourne">
    </label>
    <label>目的地（To）
      <input required id="to" type="text" placeholder="例如：Sydney">
    </label>
    <label>出行日期（Flight Date）
      <input required id="date" type="date">
    </label>

    <!-- 不再提前暴露 promo，下方只有领取按钮 -->
    <button id="claimBtn">领取 Promo Code</button>

    <div id="feedback" class="hidden success"></div>

    <div id="exfilCard" class="hidden card">
      <h4 class="danger-text">你的信息被盗取了（模拟演示）</h4>
      <div id="summaryKV"></div>
    </div>

    <table>
      <thead><tr><th>时间</th><th>行程</th><th>出行日期</th><th>Promo</th></tr></thead>
      <tbody id="recordsBody"></tbody>
    </table>
  </form>
</div>

<!-- 弹窗 -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>领取前确认</h3>
    <p>领取 code 表示同意信息收集协议。</p>
    <div class="modal-actions">
      <button id="cancelBtn" class="btn-secondary">取消</button>
      <button id="confirmBtn">确定</button>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = 'promo_demo_records_simple';
  const $ = id => document.getElementById(id);
  const nowStr = () => new Date().toLocaleString();
  const esc = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function loadRecords(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const tbody = $('recordsBody'); tbody.innerHTML='';
    arr.slice().reverse().forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.time}</td>
        <td>${esc(r.from)} → ${esc(r.to)}</td>
        <td>${esc(r.flightDate)}</td>
        <td>${esc(r.promoCode)}（${esc(r.promoLabel)}）</td>`;
      tbody.appendChild(tr);
    });
  }
  function saveRecord(rec){
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.push(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    loadRecords();
  }

  const backdrop = $('modalBackdrop');
  const openModal = () => { backdrop.style.display='flex'; };
  const closeModal = () => { backdrop.style.display='none'; };
  $('cancelBtn').addEventListener('click', closeModal);

  // 工具：基于日期计算 Promo（仅在确认后使用）
  function computePromoByDate(dateStr){
    // 仅当点击“确定”后才计算，避免提前暴露
    // 将用户选择的 YYYY-MM-DD 解析为本地日期
    const d = new Date(dateStr + 'T12:00'); // 避免时区边界问题
    const day = d.getDay(); // 0=周日, 6=周六
    if(day === 0 || day === 6){
      return { code: 'WEEKEND25', label: 'Weekend 25%' };
    }
    // 非周末的默认策略
    return { code: 'SAVE10', label: '10% off' };
  }

  $('claimBtn').addEventListener('click', () => {
    if(!$('from').value.trim() || !$('to').value.trim()){ alert('请填写出发地和目的地'); return; }
    if(!$('date').value){ alert('请选择出行日期'); return; }
    openModal();
  });

  $('confirmBtn').addEventListener('click', () => {
    closeModal();

    const from = $('from').value.trim();
    const to = $('to').value.trim();
    const flightDate = $('date').value; // YYYY-MM-DD

    // 只有在此处（用户确认后）才生成并显示 Promo
    const { code: promoCode, label: promoLabel } = computePromoByDate(flightDate);
    const claimId = promoCode + '-' + Math.random().toString(36).slice(2,7).toUpperCase();

    $('feedback').classList.remove('hidden');
    $('feedback').innerHTML = `领取成功！适用代码：<b>${esc(promoCode)}</b>，兑换码：<b>${esc(claimId)}</b>`;

    saveRecord({
      time: nowStr(),
      from, to,
      flightDate,
      promoCode,
      promoLabel,
      claimId
    });

    $('summaryKV').innerHTML = `
      <div>出发地</div><div>${esc(from)}</div>
      <div>目的地</div><div>${esc(to)}</div>
      <div>出行日期</div><div>${esc(flightDate)}</div>
      <div>Promo</div><div>${esc(promoCode)}（${esc(promoLabel)}）</div>
      <div>领取码</div><div>${esc(claimId)}</div>
    `;
    $('exfilCard').classList.remove('hidden');
  });

  loadRecords();
})();
</script>
</body>
</html>
